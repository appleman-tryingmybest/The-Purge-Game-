extends StaticBody2D
@onready var detectplayer = $PlayerSpawn/Area2D
@export var wait_time : int
var trigger_once := false
var enemy1 = preload("res://enemy_1.tscn")
var enemy2 = preload("res://enemy_2.tscn")
var enemy3 = preload("res://robot_fly.tscn")
var enemy4 = preload("res://robot_shield.tscn")
var enemy5 = preload("res://sentry_buster.tscn")
var boss = preload("res://heavy.tscn")
var ship = preload("res://ship.tscn")
var debris = preload("res://debris.tscn")
@export var random_distance : float
@export var random_enemy : int
var spawn := false
var timer : float
var enemy_amount : int = 0
var spawning := false
var special_event := false
var pause := false
@export var wave : int
@onready var animation = $AnimationPlayer
var current_loop_player: AudioStreamPlayer
var boss_spawned := false
var spawn_at := 0
@export var ship_chance := 8
@export var debris_chance := 3
@onready var score_board = $cannon/scoreboard
@onready var setting = %setting



#PRELOAD SOUNDS
var arena4_intro = preload("res://music/arena_music/arena_4/arena_4_intro.ogg")
var arena4_p1 = preload("res://music/arena_music/arena_4/arena_4_part1.ogg")
var arena4_p2 = preload("res://music/arena_music/arena_4/arena_4_part2.ogg")
var cannon_shoot = preload("res://sounds/enemy/cannon_shoot.ogg")
var boomsound = preload("res://addons/godot-git-plugin/funny-explosion-sound.ogg")
var meow = preload("res://sounds/meow.ogg")
var slip = preload("res://sounds/slip.ogg")
var scream = preload("res://sounds/scream.ogg")
var punch = preload("res://sounds/punch.ogg")
var nuke_land = preload("res://sounds/player/dropod-land.ogg")

func _on_area_2d_body_entered(body: Node2D) -> void:
	if !trigger_once and body.is_in_group("player"):
		Global.start_game = true #newstuff
		animation.play("weird_nuke")
		await get_tree().create_timer(1).timeout
		var shake = get_parent().get_node("Player")
		if shake and shake.has_method("_cam_shake"):
			shake._cam_shake(50)
		Global.allowSpawn = false
		animation.play("idle")
		trigger_once = true
		var getFunction = get_parent().get_node("music-system")
		getFunction.play_arena_music()
		play_sound_intro(arena4_intro, 2)
		_start_stuff()
		Global.arena_player = true

func play_sound (stream: AudioStream, volume:float =0.0 ):
	var arena_music = AudioStreamPlayer.new()
	arena_music.stream = stream
	arena_music.volume_db = volume
	arena_music.bus = "sounds"
	add_child(arena_music) # adds to the world
	arena_music.play() # play first
	arena_music.finished.connect(arena_music.queue_free) # remove itself after finished playing

func play_sound_intro (stream: AudioStream, volume:float =0.0 ):
	var arena_music = AudioStreamPlayer.new()
	arena_music.stream = stream
	arena_music.bus = "Music"
	arena_music.volume_db = volume
	add_child(arena_music) # adds to the world
	arena_music.play() # play first
	arena_music.finished.connect(arena_music.queue_free) # remove itself after finished playing

func _manage_arena_music():
	var target_stream = arena4_p2 if boss_spawned else arena4_p1
	# no music then make one
	if !is_instance_valid(current_loop_player):
		_start_new_track(target_stream)
		return

	# check for wrong music then switch
	if current_loop_player.stream != target_stream:
		print("Boss spawned! Swapping music to: ", target_stream.resource_path)
		current_loop_player.queue_free()
		_start_new_track(target_stream)

func _start_new_track(stream: AudioStream):
	var l = AudioStreamPlayer.new()
	l.stream = stream
	l.bus = "Music"
	l.process_mode = Node.PROCESS_MODE_ALWAYS
	l.volume_db = -4
	add_child(l)
	l.play()
	current_loop_player = l

	l.finished.connect(func():
		if is_instance_valid(l):
			l.play() # Just restart the music
	)


func _start_stuff():
	animation.play("off")
	print("start timer")
	await get_tree().create_timer(wait_time).timeout
	_activate_cannon()
	spawn = true
	print("spawning")


func spawn_enemy(enemy_type: String):
	var enemyspawn1 = $"level-detail-shared/enemy_spawn"
	var enemyspawn2 = $"level-detail-shared/enemy_spawn2"
	var world = get_parent()
	var scene_to_spawn: PackedScene

	match enemy_type:
		"enemy1":
			scene_to_spawn = enemy1 # if more enemy then repeat this
		"enemy2":
			scene_to_spawn = enemy2
		"enemy3":
			scene_to_spawn = enemy3
		"enemy4":
			scene_to_spawn = enemy4
		"enemy5":
			scene_to_spawn = enemy5
		"boss":
			scene_to_spawn = boss
		"ship":
			scene_to_spawn = ship
		"debris":
			scene_to_spawn = debris
		_:
			return
	var enemy = scene_to_spawn.instantiate() # copies stuff and prepares it	
	world.add_child(enemy) # then we add it into the world
	if randi_range(0, 1) == 0:
		enemy.global_position = enemyspawn1.global_position
	else:
		enemy.global_position = enemyspawn2.global_position
	enemy.global_position.x += randf_range(-random_distance, random_distance)
	if enemy_type == "ship":
		enemy.global_position = Vector2(-1974.0 + randf_range(0, 555), 10221.0)
	if enemy_type == "debris":
		enemy.global_position = Vector2(randf_range(-2826, 1654), 11800.0)
	print ("enemy amount ", enemy_amount)
	print ("wave ", wave)
	
@warning_ignore("unused_parameter")
func _process(delta: float) -> void:
	print ("modulate is ", score_board.modulate.a)
	if Global.game_started:
		time_elapsed += delta
		var mins = int(time_elapsed/60)
		var secs = int(time_elapsed) %60
		var time_string = "%02d:%02d" % [mins, secs]
		if score_board and score_board.has_node("timer_label"):
			score_board.get_node("timer_label").text = "TIMER:" + time_string
		print("Timerswitch:",Global.start_game,"|Current time",Global.start_time)
		
	if Global.arena_player and spawn:
		_manage_arena_music()
	if !spawn or Global.enemy_count > 0 or spawning or pause:
		return # Stop here if we aren't ready to spawn yet
	if spawn and wave == 4 and !boss_spawned and Global.enemy_count == 0:
		boss_spawned = true
		spawn_enemy("boss")
	# Handle Spawning
	if spawn and enemy_amount == 0 and wave != 0 and Global.enemy_count == 0:
		print ("starting to spawn")
		enemy_amount = randi_range(7, 10)
		if enemy_amount > 0 and !spawning:
			_spawnwave()
			print ("testing if spawned")
			wave -= 1
	if spawn and wave == 0 and Global.enemy_count == 0 and Global.arena_player == true:
		destroy_gun()
		Global.arena_player = false
		if is_instance_valid(current_loop_player):
			current_loop_player.stop()
			current_loop_player.queue_free()

func _spawnwave():
	spawning = true
	while enemy_amount != 0:
		if wave != 4:
			random_enemy = randi_range(0, 3)
		elif wave <= 4:
			random_enemy = randi_range(0, 4)
		if random_enemy == 0:
			spawn_enemy("enemy1")
		if random_enemy == 1:
			spawn_enemy("enemy2")
		if random_enemy == 2:
			spawn_enemy("enemy3")
		if random_enemy == 3:
			spawn_enemy("enemy4")
		if random_enemy == 4:
			spawn_enemy("enemy5")
		enemy_amount -= 1
	spawning = false

func _activate_cannon():
	var cooldown : float
	cooldown = randf_range(1, 5)
	while wave != 0: 
		await get_tree().create_timer(cooldown).timeout
		animation.play("point_up")
		print ("point up")
		await animation.animation_finished
		animation.play("idle_up")
		print ("face up")
		await animation.animation_finished
		await get_tree().create_timer(randf_range(8, 14)).timeout
		animation.play("fire")
		await animation.animation_finished
		spawn_ship()
		if randi_range(0, debris_chance):
			spawn_debris()
		else:
			debris_chance -= 1
		await get_tree().create_timer(randf_range(2, 9)).timeout
		animation.play("point_down")
		await animation.animation_finished
		animation.play("idle")
		cooldown = randf_range(4, 6)

func spawn_ship():
	print ("rolling chance for ship")
	if randi_range(0, ship_chance) == 0:
		ship_chance += 1
		spawn_enemy("ship")
		print ("nice spawning ship")
	else:
		ship_chance -= 1

func spawn_debris():
	debris_chance += 1
	var amount = randi_range(2, 9)
	for i in amount:
		spawn_enemy("debris")

func _shoot_sound():
	play_sound(cannon_shoot, 8)

func boom():
	play_sound(boomsound)

func meowSound():
	play_sound(meow)
	
func slipSound():
	play_sound(slip)

func screamSound():
	play_sound(scream)

func Mmu():
	get_tree().paused = true
	
func destroy_gun():
	print("hi")
	animation.play("destroy")
	await animation.animation_finished
	await get_tree().create_timer(6).timeout
	print("pls")
	Global.camera_Type = 3
	setting.hide()
	animation.play("mmu_boom")
	print("mmuboom?")
	await animation.animation_finished
	Global.game_started = false
	Global.start_game = false
	scoreboard()
	
func scoreboard():
	var music_sys = get_parent().get_node("music-system")
	music_sys.end_arena()
	print("timer start")
	Global.start_game = false
	var mins= int(Global.start_time/60)
	var secs = int(Global.start_time)%60
	var time_string = "%02d:%02d" % [mins, secs]
	var box = $cannon/scoreboard/VBoxContainer
	box.get_node("timer_label").text = "Time:   " + time_string
	score_board.modulate.a  = 0.0
	var timer_ = $cannon/scoreboard/VBoxContainer/timer_label
	var kill = $cannon/scoreboard/VBoxContainer/kill_count
	var bullet = $cannon/scoreboard/VBoxContainer/bullets_shot
	var death = $cannon/scoreboard/VBoxContainer/death_count
	var damage = $cannon/scoreboard/VBoxContainer/damage_taken
	var deathcount = str(Global.death_count)
	var killcount_string = str(Global.enemy_kill_count)
	var bulletscount = str(Global.bullets_count)
	var take_damage = str(int(Global.total_damage_taken))
	box.get_node("death_count").text = "Death  Count:   " + deathcount
	box.get_node("kill_count").text = "Kill  Count:   " + killcount_string
	box.get_node("bullets_shot").text = "Bullets  Shot:    " + bulletscount
	box.get_node("damage_taken").text = "Damage  Taken :    " + take_damage
	timer_.hide()
	kill.hide()
	bullet.hide()
	death.hide()
	damage.hide()
	score_board.show()
	var tween = create_tween()
	tween.tween_property(score_board,"modulate:a",1.0,1.0)
	await get_tree().create_timer(1).timeout
	timer_.show()
	play_sound(punch)
	await get_tree().create_timer(1).timeoutd
	bullet.show()
	play_sound(punch)
	await get_tree().create_timer(1).timeout
	kill.show()
	play_sound(punch)
	await get_tree().create_timer(1).timeout
	death.show()
	play_sound(punch)
	await get_tree().create_timer(1).timeout
	damage.show()
	play_sound(punch)
	await get_tree().create_timer(1).timeout
func damage_record(amount:int):
	var player = get_parent().get_node("Player")
	var _health :int = 100
	var player_hurtbox = player.get_node("hurt_area")
	player_hurtbox.area_entered.connect(_damage_detect)

	
func _damage_detect(area: Area2D):
	if area.has_method("give_damage"):  #has_method= do you have this
		var amount = area.give_damage()
		Global.total_damage_taken += amount #record
		print("detected",amount,"Total:", Global.total_damage_taken)
		


func _on_button_pressed() -> void:
	print("return to main menu from last scene")
	get_tree().paused = false
	Global.arena_player = false
	Global.allowSpawn = true
	Global.restart = true
	Global.start_game = false
	Global.camera_Type = 2
	Global.mountain = true
	Global.cloud = true
	Global.tree = true
	Global.restart = true
	Global.enemy_count = 0
	Global.total_damage_taken = 0
	Global.death_count = 0
	Global.enemy_kill_count = 0
	Global.bullets_count = 0
	Global.start_time = 0.0
	print("reset value mm")
	get_tree().reload_current_scene()

func _nuke_sound():
	play_sound(nuke_land)

	
